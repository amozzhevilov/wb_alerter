# WB alerter: поиск доступных слотов на складах WB

## Алгоритм работы

1. При старте приложение через API WB запрашивает полный перечень складов и сохраняет их в таблице БД **warehouses**, которая имеет следующую структуру:

| Стобец | Значение |
| :---: | :---: | 
| id | Идентификатор склада |
| name | Наименование склада |
| updtime | Время обновления информации о складе |
---
2. Каждые 15 секунд приложение через API WB собирается информацию о всех доступных слотах на складах и сохраняет их в таблицу **limits**, которая имеет следующую структуру:

| Стобец | Значение |
| :---: | :---: | 
| warehouse_id | Идентификатор склада |
| date | Дата свободного слота |
| coef | Коэффициент приемки: от -1 до 20 |
| type | Тип приемки: короб, палета и т.д. |
---
3. Взаимодействие с конечным пользователем осуществляется через Telegram бота. Пользователь по средствам меню создает заявки на отслеживание слотов на складах, в соответствии с заданными критериями. Указанные заявки сохраняются в таблицу **orders**, которая имеет следующую структуру:

| Стобец        | Значение |
|  :---:        | :---: | 
|  user_id      | Идентификатор пользователя |
|  warehouse_id | Идентификатор склада отслеживания  |
|  max_coef     | Максимальный коэффициент приемки, указывается в заявке |
|  delay  | Временной промежуток в днях для логистического плеча |
|  type | Тип приемки, указывается в заявке |
---
4. При обновлении информации о доступных слотах на складах WB (шаг 3) формируется массив данных со свободными слотами, которые отслеживают пользователеи. Данные в массиве групируются по идентификатору пользователя и отправляются ему в Telegram.
---
5. Кроме того, в боте реализован справочный функционал, который на основании данных о свободных слотах позволяет осуществлять следующие выборки:
- показать все склады WB
- показать все доступные склады WB
- показать все СЦ WB
- показать все доступные СЦ WB
- найти свободные слоты в соответствии с заданной выборкой

## Процесс поставки

Для WB alerter реализованы процессы CI/CD посредством workflows:
- анализ кода с помощью flake8
- юнит-тестирование
- сборка и загрузка docker образа в репозиторий cr.yandex/crp6qutme8n1opblnn2f/

Анализ кода и юнит тестирование выполняются для каждого события push в репозиторий.

Сборка и загрузка docker образа выполняются для каждого события push, тегирования и PR в ветку main.

## Версионирование

Для WB alerter принят формат SemVer. Версионирование осуществляется через указание tag, формат указания версии `vX.Y.Z`

## Запуск приложения

1. Задать следующие переменные окружения:
```
WB_TOKEN - токен для доступа к API WB
TELEGRAM_BOT_TOKEN - токен для доступа к Telegram Bot
```
2. Выполнить команду:
`docker compose up -d`

## ToDo

- Использование Redis для хранения состояний при работе пользователя с меню
- Использование Webhooks при работае с telegram ботом
- Классификация аккаунтов пользователь на платные/бесплатные
- Возможность рассылки сообщений всем пользователям

